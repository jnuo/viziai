# Ralph Progress Log - Phase 1: Ship the Free Product
# Started: 2026-02-28
# Branch: ralph/phase-1-ship-free-product

---
## 2026-02-28 - STORY-001: Add typecheck script
- Added "typecheck": "tsc --noEmit" to web/package.json scripts
- Installed @types/jest (was missing, causing typecheck failures in test files)
- Excluded e2e/ from tsconfig.json and jest.config.js (Playwright tests were leaking into tsc and Jest)
- Verified: typecheck passes (0 errors), tests pass (15/15), build succeeds
- Files changed: web/package.json, web/package-lock.json, web/tsconfig.json, web/jest.config.js
- Learnings: e2e tests need to be excluded from both tsconfig and Jest config — they use Playwright's own type system and test runner

---
## 2026-02-28 - STORY-002: Add German locale
- Added 'de' locale to i18n config (label: Deutsch, BCP47: de-DE)
- Created web/messages/de.json with all 334 keys translated to German
- Key structure verified identical to en.json via script comparison
- Files changed: web/src/i18n/config.ts, web/messages/de.json
- Learnings: Use node script to verify key parity between locale files — catches structural mismatches before build

---
## 2026-02-28 - STORY-003: Add French locale
- Added 'fr' locale to i18n config (label: Français, BCP47: fr-FR)
- Created web/messages/fr.json with all 334 keys translated to French
- Key structure verified identical to en.json
- Files changed: web/src/i18n/config.ts, web/messages/fr.json
- Learnings: Same pattern as STORY-002 — locale additions are mechanical once the first one is done

---
## 2026-02-28 - STORY-006: German metric aliases migration
- Created db-schema/migrations/20260228_german_metric_aliases.sql with 55 German → Turkish alias mappings
- Covers: CBC, metabolic panel, liver, kidney, lipids, thyroid, iron, inflammation, vitamins, coagulation
- Used ON CONFLICT (alias) DO NOTHING for idempotent re-runs
- Files changed: db-schema/migrations/20260228_german_metric_aliases.sql
- Learnings: Canonical names include full parenthetical suffixes like "ALT (Alanin Aminotransferaz)" — must match exactly

---
## 2026-02-28 - STORY-007: French metric aliases migration
- Created db-schema/migrations/20260228_french_metric_aliases.sql with 59 French → Turkish alias mappings
- Same coverage as German: CBC, metabolic, liver, kidney, lipids, thyroid, iron, inflammation, vitamins, coagulation
- Files changed: db-schema/migrations/20260228_french_metric_aliases.sql
- Learnings: French medical terms often use accented characters (é, è, ê) — important for correct alias matching

---
## 2026-02-28 - STORY-004: Report cap enforcement — backend
- Added 5-report-per-profile cap check to POST /api/upload, after profile access verification and before file processing
- Counts existing reports in processed_files table; returns 403 with reportCount and reportCap if >= 5
- Added translation keys to all 5 locale files: api.reportCapReached, pages.upload.reportCapReached, pages.upload.reportCapDescription, pages.dashboard.reportCount
- Code review found: race condition (concurrent uploads can bypass cap) — acceptable risk for personal health app with <5 users; error string casing inconsistency — fixed
- Verified: typecheck passes, tests pass (15/15), build succeeds
- Files changed: web/src/app/api/upload/route.ts, web/messages/tr.json, web/messages/en.json, web/messages/es.json, web/messages/de.json, web/messages/fr.json
- Learnings: Cap check placed before file read/upload to avoid wasting resources. Response includes reportCount/reportCap for STORY-005 frontend consumption

---
## 2026-02-28 - STORY-010: Blog infrastructure with locale-prefixed routing
- Set up MDX blog with path-based locale routing (/[locale]/blog/[slug]) for SEO
- Installed next-mdx-remote, gray-matter, @tailwindcss/typography
- Created blog utility library (web/src/lib/blog.ts) with path traversal protection
- Blog listing page with semantic HTML (ul/li, time elements), WCAG AA accessibility
- Article page with MDX rendering, reading time, description, hreflang alternates, CTA
- Static generation via generateStaticParams + dynamicParams=false (prevents DoS)
- Placeholder articles in EN and TR to verify cross-locale hreflang linking
- Design review loop: 3 agents (Brand, A11y, Design Quality) — required 2 iterations
- Code review: security (path boundary), performance (deduplicate alternates), architecture (route collision risk)
- Verified: typecheck passes, tests pass (15/15), build succeeds with all routes SSG
- Files changed: web/src/lib/blog.ts, web/src/app/[locale]/layout.tsx, web/src/app/[locale]/blog/page.tsx, web/src/app/[locale]/blog/[slug]/page.tsx, web/src/app/globals.css, web/src/app/layout.tsx, web/package.json, web/content/blog/en/*.mdx, web/content/blog/tr/*.mdx
- Learnings:
  - Tailwind v4 uses @plugin directive for JS plugins in CSS, not @import
  - Path-based locale routes can coexist with cookie-based next-intl — but <html lang> comes from cookie, not URL (known limitation, would require layout restructuring to fix)
  - [locale] dynamic segment captures any single-segment path — document this risk for future route additions
  - Static generation (generateStaticParams + dynamicParams=false) eliminates runtime file I/O and prevents resource exhaustion attacks
  - Inline locale Records are correct for path-based locale pages — useTranslations() reads from cookie, not URL param

---
## 2026-02-28 - STORY-012: Update Google Analytics for viziai.app
- Replaced GA4 measurement ID G-7SD063Z4ST with G-TWM75R9VKP in layout.tsx (both script src and config call)
- Created web/src/lib/analytics.ts — trackEvent helper that wraps window.gtag() with SSR safety
- Added 3 event tracking points: login_completed (login page), upload_started (upload page), locale_switched (locale hook)
- Code review caught: event name "signup_completed" was misleading (fires on every auth, not just signups) — renamed to "login_completed"
- Code review caught: over-defensive type casting (double `as unknown as`) — simplified to `(window as any).gtag`
- Verified: typecheck passes, tests pass (15/15), build succeeds
- Files changed: web/src/app/layout.tsx, web/src/lib/analytics.ts, web/src/app/login/page.tsx, web/src/app/upload/page.tsx, web/src/hooks/use-locale-switch.ts
- Learnings: GA event naming should reflect what actually happens (login vs signup distinction matters for analytics accuracy)

---
## 2026-02-28 - STORY-009: SEO meta tags + Open Graph + structured data
- Converted root layout static `metadata` to `generateMetadata()` with locale-aware title template and description
- Split landing page into server component (page.tsx) + client component (landing-page.tsx) to enable `generateMetadata()` export
- Added OG tags (title, description, image, type, siteName), Twitter summary_large_image card, JSON-LD SoftwareApplication structured data
- Added `seo` section to all 5 locale files with: siteTitle, titleTemplate, defaultDescription, landingTitle, landingDescription, ogImageAlt
- Code review caught: JSON-LD description was hardcoded English — fixed to use `t("landingDescription")` for locale consistency
- Verified: typecheck passes, tests pass (15/15), build succeeds
- Files changed: web/src/app/layout.tsx, web/src/app/page.tsx, web/src/components/landing-page.tsx, web/messages/*.json
- Learnings: Client components can't export generateMetadata — split into server wrapper + client content for pages needing both SEO metadata and client-side interactivity

---
## 2026-02-28 - STORY-008: Privacy policy page
- Created /privacy route with server component (metadata) + client component (privacy-content.tsx)
- Privacy content covers 7 sections: data collection, storage, AI processing, cookies, GDPR rights, data deletion, contact
- Added `privacy` section to all 5 locale files with full translations
- Added footer link to /privacy from landing page
- Design review loop: Brand compliance PASS, Design quality PASS, Web best practices flagged missing `<main>` landmark — fixed
- Verified: typecheck passes, tests pass (15/15), build succeeds
- Files changed: web/src/app/privacy/page.tsx, web/src/app/privacy/privacy-content.tsx, web/src/components/landing-page.tsx, web/messages/*.json
- Learnings: Privacy pages should use calm, clear language — not legalese. Section component pattern keeps privacy content scannable.

---
## 2026-02-28 - STORY-005: Report cap enforcement — frontend upgrade prompt
- Updated profile switcher to show X/5 report count with warning color (amber) when at cap
- Updated upload page: inline warning banner before drop zone when at cap, disabled dropzone when at cap, specific 403 cap error handling
- Code review caught: magic number 5 hardcoded in 4 places — extracted to shared FREE_REPORT_CAP constant in web/src/lib/constants.ts
- Code review caught: profile-switcher borrowed translation from pages.dashboard namespace — moved reportCount key to components.profileSwitcher
- Code review caught: dropzone not disabled when at cap — added isAtCap to disabled condition
- Design review: Brand compliance PASS (amber warning correct), Accessibility PASS (no role needed for static banner), Design quality PASS (correct placement and hierarchy)
- Verified: typecheck passes, build succeeds
- Files changed: web/src/lib/constants.ts, web/src/app/upload/page.tsx, web/src/components/profile-switcher.tsx, web/src/app/api/upload/route.ts, web/messages/*.json
- Learnings: Shared constants (FREE_REPORT_CAP) prevent magic number scatter when same value used across frontend and backend. Components should own their translation keys — never reach into page-specific namespaces.

---
## 2026-02-28 - STORY-013: First SEO article — Track Blood Tests Across Countries
- Expanded EN and TR placeholder articles from ~300 to ~850-900 words with full content
- Created 3 new locale articles: ES (1046 words), DE (902 words), FR (1092 words)
- All 5 articles share canonicalLocale: "en" for proper SEO canonical linking
- hreflang alternates automatically generated by getAlternateLocales() in blog.ts
- Content covers: multi-language metric names problem, AI extraction, alias normalization, unified dashboard, supported languages, privacy, CTA
- Localized slugs: en/track-blood-tests-across-countries, tr/kan-testi-sonuclarini-ulkeler-arasi-takip, es/seguimiento-analisis-sangre-entre-paises, de/blutwerte-laenderuebergreifend-verfolgen, fr/suivi-analyses-sang-entre-pays
- Each translation adapts examples for target audience (e.g., DE article emphasizes Turkey-Germany move, FR article uses France-Germany, ES uses Latin America-Spain)
- Verified: build succeeds, all 5 articles SSG'd correctly (24 static pages, up from 21)
- Files changed: web/content/blog/en/*.mdx, web/content/blog/tr/*.mdx, web/content/blog/es/*.mdx (new), web/content/blog/de/*.mdx (new), web/content/blog/fr/*.mdx (new)
- Learnings: Blog articles with canonicalLocale + getAlternateLocales() handle cross-locale SEO linking automatically — no manual hreflang tags needed

---
## 2026-02-28 - STORY-011: Landing page optimization
- Added "How It Works" 3-step section: Upload PDF → AI Extracts → Track Trends (with brand-colored icons)
- Added social proof placeholder section: 5 languages, family profiles, 100+ metric aliases stats
- Updated hero CTA from "Get Started" to "Get Started Free" (new `getStartedFree` key)
- Enhanced footer: language selector (LocaleSwitcher), blog link (locale-prefixed), privacy link, copyright
- Added ~20 new translation keys to all 5 locale files (howItWorks, howItWorksSteps, socialProof, footer)
- TypeScript: Used `as const` key references in HOW_IT_WORKS_STEPS array to satisfy next-intl's strict key typing
- Verified: typecheck passes, build succeeds
- Files changed: web/src/components/landing-page.tsx, web/messages/*.json
- Learnings: next-intl v4 type-checks translation keys strictly — template literals like `step${index}Title` fail. Use explicit `as const` key strings in arrays.


